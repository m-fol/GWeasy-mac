name: GWeasy macOS Fetch Benchmark

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  benchmark:
    runs-on: macos-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          activate-environment: GWeasy
          environment-file: environment.yml
          auto-activate-base: false

      - name: Install Pip Dependencies
        shell: bash -l {0}
        run: |
          pip install -r requirements.txt

      - name: Benchmark Noise Fetching Time
        shell: bash -l {0}
        run: |
          echo "Starting the benchmark using the GWeasy environment..."
          
          python << 'EOF'
          import time
          import sys
          import os

          try:
              from gwpy.timeseries import TimeSeries
              print("GWpy library loaded successfully.")
          except ImportError:
              print("Failed to load dependencies. Check requirements.txt.")
              sys.exit(1)
              
          detector = 'H1'
          t0 = 1126259446
          t1 = 1126259478

          print(f"Fetching {t1-t0}s of noise data from {detector}...")

          start_clock = time.time()

          data = TimeSeries.fetch_open_data(detector, t0, t1)
          
          end_clock = time.time()

          duration = end_clock - start_clock
          print("\n" + "="*35)
          print(f"MACOS FETCH BENCHMARK COMPLETE")
          print("="*35)
          print(f"Time Taken: {duration:.4f} seconds")
          print(f"Data Points: {len(data)}")
          print(f"Fetch Speed: {len(data)/duration:.2f} samples/sec")
          print("="*35)
          EOF
