name: GWeasy macOS Performance Check

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  benchmark-mac:
    runs-on: macos-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          activate-environment: GWeasy
          environment-file: environment.yml
          python-version: "3.10"
          auto-activate-base: false

      - name: Install Pip Dependencies
        shell: bash -l {0}
        run: |
          # Per your instructions: Option 2 setup
          pip install -r requirements.txt

      - name: Benchmark Noise Fetch
        shell: bash -l {0}
        run: |
          export PYTHONPATH=$PYTHONPATH:.
          
          echo "Starting Benchmark on macOS..."
          
          python << 'EOF'
          import os
          import sys
          import time
          from unittest.mock import MagicMock

          import tkinter as tk
          tk.Tk = MagicMock()
          tk.Toplevel = MagicMock()
          tk.mainloop = MagicMock()

          try:
              import gweasy
              print("Successfully linked to gweasy.py logic.")
          except ImportError as e:
              print(f"Error: Could not find gweasy.py in {os.getcwd()}")
              print(f"Path searched: {sys.path}")
              sys.exit(1)

          from gwpy.timeseries import TimeSeries
          
          detector = 'H1'
          start = 1126259446 
          end = 1126259478 
          
          print(f"Commencing fetch of {detector} data...")
          
          start_time = time.time()
          data = TimeSeries.fetch_open_data(detector, start, end)
          end_time = time.time()
          
          duration = end_time - start_time
          
          print("\n" + "="*30)
          print("MACOS PERFORMANCE RESULTS")
          print("="*30)
          print(f"Software: GWeasy-mac")
          print(f"Fetch Time: {duration:.4f} seconds")
          print(f"Data Rate: {len(data)/duration:.2f} samples/sec")
          print("="*30)
          EOF
